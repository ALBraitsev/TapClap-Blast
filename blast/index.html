<!DOCTYPE html>
<html>
<title>TAPCLAP Blast Test</title>

<body>
    <form>
        <div>
            <label for="geimBoardWidth">Geim Board Width (M):</label>
            <input type="number" id="geimBoardWidth" name="geimBoardWidth" min="2" max="10" value="10" required>

            <label for="geimBoardHeight">Geim Board Height (N):</label>
            <input type="number" id="geimBoardHeight" name="geimBoardHeight" min="2" max="10" value="10" required>

            <label for="colorsCount">Colors Count (C):</label>
            <input type="number" id="colorsCount" name="colorsCount" min="3" max="12" value="3" required>
        </div>
        <div>
            <input type="button" id="resetButton" value="Reset Game Board">
        </div>
    </form>

    <canvas id="myCanvas" width="640" height="480" style="border:1px solid #000000;">
    </canvas>


    <script>
        class HSLColor {
            constructor(h, s, l, a = 100) {
                this.hue = h;
                this.saturation = s;
                this.lightness = l;
                this.alpha = a;
            }
            color() {
                return `hsla(${this.hue}deg, ${this.saturation}%, ${this.lightness}%, ${this.alpha}%)`
            }
        };

        function getPalette(num_colors) {
            var palette = [];
            for (var i = 0, di = 360 / num_colors; i < 360; i += di) {
                var hue = i;
                var saturation = 90 + Math.random() * 10;
                var lightness = 50 + Math.random() * 10;
                palette.push(new HSLColor(hue, saturation, lightness));

            }
            return palette;
        }

        class Tile {
            constructor(row, column, width, height, color) {
                this.row = row;
                this.col = column;
                this.width = width;
                this.height = height;
                this.color = color;
            }
            draw(ctx) {
                ctx.fillStyle = this.color.color();
                ctx.fillRect(this.width * this.col, this.height * this.row, this.width, this.height);
            }
        };

        class GameBoard {
            constructor(canvas, M, N, C) {
                this.canvas = canvas;
                this.columns = M;
                this.rows = N;
                this.colorsCount = C;
                
                this.ctx2d = this.canvas.getContext("2d");
                this.palette = getPalette(this.colorsCount);
                this.tailWidth = this.canvas.width / this.columns;
                this.tailHeight = this.canvas.height / this.rows;

                this.tiles = [];
                for (var row = 0; row < this.rows; ++row) {
                    for (var column = 0; column < this.columns; ++column) {
                        var colorNumber = parseInt(Math.random() * this.colorsCount);
                        this.tiles.push(new Tile(row, column, this.tailWidth, this.tailHeight, this.palette[colorNumber]));
                    }
                }

                this.canvas.removeEventListener('click', null);
                this.canvas.addEventListener('click', function(event) {gameBoard.onClick(event);});
            }
            draw() {
                this.ctx2d.clearRect(0, 0, this.canvas.width, this.canvas.height);
                this.tiles.forEach((n, i) => { if (n) n.draw(this.ctx2d) });
            }
            getTiles(idx, row, col, color = null) {
                var npp = row * this.columns + col;

                if (idx.includes(npp)) return;
                if (this.tiles[npp] == null) return;

                if (color) {
                    if (this.tiles[npp].color == color) {
                        idx.push(npp);
                    }
                    else {
                        return;    
                    }
                }
                else {
                    idx.push(npp);
                }

                if (row > 0) this.getTiles(idx, row - 1, col, this.tiles[npp].color);
                if (row < this.rows - 1) this.getTiles(idx, row + 1, col, this.tiles[npp].color);
                if (col > 0) this.getTiles(idx, row, col - 1, this.tiles[npp].color);
                if (col < this.columns - 1) this.getTiles(idx, row, col + 1, this.tiles[npp].color);
            }
            onClick(event) {
                var row = parseInt(event.layerY / this.tailHeight);
                var col = parseInt(event.layerX / this.tailWidth);

                var idx = [];
                this.getTiles(idx, row, col);
                if (idx.length > 1)
                    idx.forEach((n) => { this.tiles[n] = null; });

                this.draw();
            }
        };

        var gameBoard = null;

        var resetButton = document.getElementById("resetButton");
        resetButton.addEventListener('click', function (event) {
            var canvas = document.getElementById("myCanvas");
            var M = parseInt(document.getElementById("geimBoardWidth").value);
            var N = parseInt(document.getElementById("geimBoardHeight").value);
            var C = parseInt(document.getElementById("colorsCount").value);

            gameBoard = new GameBoard(canvas, M, N, C);
            gameBoard.draw();
        });

    </script>
</body>

</html>
